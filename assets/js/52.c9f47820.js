(window.webpackJsonp=window.webpackJsonp||[]).push([[52],{529:function(s,t,a){"use strict";a.r(t);var e=a(19),n=Object(e.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"起因"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#起因"}},[s._v("#")]),s._v(" 起因")]),s._v(" "),a("ul",[a("li",[s._v("本来用的好好的vpn，突然频繁断，然后使用finalshell连接vpn服务器，也频繁断开，折腾一天，啥都试了，以下是解决步骤")])]),s._v(" "),a("h2",{attrs:{id:"修改固定ip地址"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#修改固定ip地址"}},[s._v("#")]),s._v(" 修改固定ip地址")]),s._v(" "),a("div",{staticClass:"language-shell script extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("vi")]),s._v(" /etc/netplan/50-cloud-init.yaml\n\nnetwork:\n    ethernets:\n        enp0s17:\n          addresses: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".0.X/24"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n          gateway4: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".0.1\n          nameservers:\n            addresses: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".0.1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    version: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n")])])]),a("ul",[a("li",[s._v("netplan apply 进行提交")])]),s._v(" "),a("h2",{attrs:{id:"修改frpc的映射地址"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#修改frpc的映射地址"}},[s._v("#")]),s._v(" 修改frpc的映射地址")]),s._v(" "),a("ul",[a("li",[s._v("local_ip 改成新的地址")])]),s._v(" "),a("div",{staticClass:"language-shell script extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("common"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nserver_addr "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" \nserver_port "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" \nauthentication_method "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" token\ntoken "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" \n\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("vpn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("type")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" tcp\nlocal_ip "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".0.x\nlocal_port "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" \nremote_port "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" \n")])])]),a("h2",{attrs:{id:"修改server-conf"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#修改server-conf"}},[s._v("#")]),s._v(" 修改server.conf")]),s._v(" "),a("ul",[a("li",[s._v("修改local的地址")])]),s._v(" "),a("div",{staticClass:"language-shell script extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("vi")]),s._v(" /etc/openvpn/server/server.conf\n\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("local")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".0.x\nport \nproto tcp\ndev tun\nca ca.crt\ncert server.crt\nkey server.key\ndh dh.pem\nauth SHA512\ntls-crypt tc.key\ntopology subnet\nserver "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.8")]),s._v(".0.0 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("255.255")]),s._v(".255.0\npush "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"redirect-gateway def1 bypass-dhcp"')]),s._v("\nifconfig-pool-persist ipp.txt\npush "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"dhcp-option DNS 8.8.8.8"')]),s._v("\npush "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"dhcp-option DNS 8.8.4.4"')]),s._v("\nclient-to-client\nkeepalive "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("120")]),s._v("\ncipher AES-256-CBC\nuser nobody\ngroup nogroup\npersist-key\npersist-tun\nstatus openvpn-status.log\nverb "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("\ncrl-verify crl.pem\n")])])]),a("h2",{attrs:{id:"修改openvpn-iptables的配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#修改openvpn-iptables的配置"}},[s._v("#")]),s._v(" 修改openvpn-iptables的配置")]),s._v(" "),a("ul",[a("li",[s._v("这也是最关键的，卡在这步挺久。查的github上的issue才解决的，"),a("a",{attrs:{href:"https://github.com/Nyr/openvpn-install/issues/770",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://github.com/Nyr/openvpn-install/issues/770"),a("OutboundLink")],1)]),s._v(" "),a("li",[s._v("修改了配置之后需要reboot")])]),s._v(" "),a("div",{staticClass:"language-shell script extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("vi")]),s._v(" /etc/systemd/system/openvpn-iptables.service\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Unit"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Before")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("network.target\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Service"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Type")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("oneshot\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ExecStart")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/sbin/iptables -t nat -A POSTROUTING -s "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.8")]),s._v(".0.0/24 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" -d "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.8")]),s._v(".0.0/24 -j SNAT --to "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".0.x\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ExecStart")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/sbin/iptables -I INPUT -p tcp --dport "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1194")]),s._v(" -j ACCEPT\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ExecStart")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/sbin/iptables -I FORWARD -s "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.8")]),s._v(".0.0/24 -j ACCEPT\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ExecStart")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/sbin/iptables -I FORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ExecStop")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/sbin/iptables -t nat -D POSTROUTING -s "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.8")]),s._v(".0.0/24 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" -d "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.8")]),s._v(".0.0/24 -j SNAT --to "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".0.x\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ExecStop")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/sbin/iptables -D INPUT -p tcp --dport "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1194")]),s._v(" -j ACCEPT\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ExecStop")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/sbin/iptables -D FORWARD -s "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.8")]),s._v(".0.0/24 -j ACCEPT\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ExecStop")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/sbin/iptables -D FORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("RemainAfterExit")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("yes\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Install"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("WantedBy")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("multi-user.target\n")])])])])}),[],!1,null,null,null);t.default=n.exports}}]);