(window.webpackJsonp=window.webpackJsonp||[]).push([[67],{540:function(a,s,t){"use strict";t.r(s);var e=t(19),r=Object(e.a)({},(function(){var a=this,s=a.$createElement,t=a._self._c||s;return t("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[t("h2",{attrs:{id:"官网的备份和恢复的教程"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#官网的备份和恢复的教程"}},[a._v("#")]),a._v(" 官网的备份和恢复的教程")]),a._v(" "),t("ul",[t("li",[t("a",{attrs:{href:"http://www.postgres.cn/docs/11/continuous-archiving.html",target:"_blank",rel:"noopener noreferrer"}},[a._v("http://www.postgres.cn/docs/11/continuous-archiving.html"),t("OutboundLink")],1)])]),a._v(" "),t("h2",{attrs:{id:"开启连续归档-增量备份"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#开启连续归档-增量备份"}},[a._v("#")]),a._v(" 开启连续归档(增量备份)")]),a._v(" "),t("ul",[t("li",[a._v("$PGDATA 即集簇目录 找到postgres.conf")])]),a._v(" "),t("h3",{attrs:{id:"集簇目录"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#集簇目录"}},[a._v("#")]),a._v(" 集簇目录")]),a._v(" "),t("p",[a._v("表示为数据卷的主目录，对应容器里的/var/lib/postgres/data")]),a._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("root@localhost pgsql"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("## ll")]),a._v("\n总用量 "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("8")]),a._v("\n-rw-r--r--.  "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v(" root    root  "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("333")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("9")]),a._v("月  "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("28")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("16")]),a._v(":49 docker-compose.yml\ndrwx------. "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("19")]),a._v(" polkitd root "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("4096")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("10")]),a._v("月 "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("12")]),a._v(" 09:34 pgdata\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("root@localhost pgsql"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("## vi docker-compose.yml ")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("root@localhost pgsql"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("## vi pgdata/postgresql.conf ")]),a._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("###")]),a._v("\nwal_level "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" replica\n\narchive_mode "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" on\n\narchive_command "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v("'test ! -f /backup/pg_archive/%f.gz && gzip < %p > /backup/pg_archive/%f.gz'")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("###")]),a._v("\n\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("root@localhost pgsql"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("## docker-compose down")]),a._v("\nStopping pgsql "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("..")]),a._v(". "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("done")]),a._v("\nRemoving pgsql "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("..")]),a._v(". "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("done")]),a._v("\nRemoving network pgsql_default\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("root@localhost pgsql"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("## docker-compose up -d")]),a._v("\nCreating network "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"pgsql_default"')]),a._v(" with the default driver\nCreating pgsql "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("..")]),a._v(". "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("done")]),a._v("\n")])])]),t("h3",{attrs:{id:"重新加载postgres-conf"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#重新加载postgres-conf"}},[a._v("#")]),a._v(" 重新加载postgres.conf")]),a._v(" "),t("ul",[t("li",[a._v("对archive_command 生效")])]),a._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[a._v("SELECT pg_reload_conf"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n")])])]),t("h3",{attrs:{id:"常用的归档配置如下"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#常用的归档配置如下"}},[a._v("#")]),a._v(" 常用的归档配置如下")]),a._v(" "),t("ol",[t("li",[a._v("非压缩")])]),a._v(" "),t("p",[a._v("archive_command = 'cp %p /appdata/pgsql/pg_archive/%f && echo %f >> /appdata/pgsql/pg_archive/archive.list'"),t("br"),a._v("\nrestore_command = 'cp /appdata/pgsql/pg_archive/%f %p'"),t("br"),a._v("\n2. 压缩 gzip")]),a._v(" "),t("p",[a._v("archive_command = 'gzip < %p > /appdata/pgsql/pg_archive/%f.gz'"),t("br"),a._v("\nrestore_command = 'gunzip < /appdata/pgsql/pg_archive/%f.gz > %p'"),t("br"),a._v("\n3. 压缩 bzip2")]),a._v(" "),t("p",[a._v("archive_command = 'bzip2 < %p > /appdata/pgsql/pg_archive/%f.bz2'"),t("br"),a._v("\nrestore_command = 'bunzip2 < /appdata/pgsql/pg_archive/%f.bz2 > %p'"),t("br"),a._v("\n4. 压缩 lz4")]),a._v(" "),t("p",[a._v("archive_command = 'lz4 -f -q -z %p /appdata/pgsql/pg_archive/%f.lz4'"),t("br"),a._v("\nrestore_command = 'lz4 -f -q -d /appdata/pgsql/pg_archive/%f.lz4 %p'"),t("br"),a._v("\n5. scp方式")]),a._v(" "),t("p",[a._v("archive_command = 'scp %p dragon02:/appdata/pgsql/pg_archive/%f'"),t("br"),a._v("\nrestore_command = 'scp dragon02:/appdata/pgsql/pg_archive/%f %p'"),t("br"),a._v("\n6. rsync方式")]),a._v(" "),t("p",[a._v("archive_command = 'rsync -a %p barman@dragon02:/appdata/pgsql/pg_archive/%f'"),t("br"),a._v("\nrestore_command = 'rsync -a barman@dragon02:/appdata/pgsql/pg_archive/%f %p'"),t("br"),a._v("\n7. windows")]),a._v(" "),t("p",[a._v('archive_command = \'copy "%p" "C:\\appdata\\pgsql\\pg_archive\\%f"\'')]),a._v(" "),t("h3",{attrs:{id:"获取用户信息-并赋予备份目录权限"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#获取用户信息-并赋予备份目录权限"}},[a._v("#")]),a._v(" 获取用户信息 并赋予备份目录权限")]),a._v(" "),t("ul",[t("li",[a._v("注：因wal归档有以postgres身份执行的cp命令，所以需要该操作")])]),a._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("root@localhost backup"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("## docker exec -it pgsql bash")]),a._v("\nroot@72bd09e3b44e:/"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("## su postgres")]),a._v("\npostgres@72bd09e3b44e:/$ "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("who")]),a._v(" am i "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("&&")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("id")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("uid")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("999")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("postgres"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("gid")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("999")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("postgres"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("groups")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("999")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("postgres"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(",103"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("ssl-cert"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n")])])]),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("root@localhost data"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("## mkdir -p /backup/pg_archive")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("root@localhost data"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("## chown -R 999:999 backup/")]),a._v("\n")])])]),t("h2",{attrs:{id:"进行全量备份"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#进行全量备份"}},[a._v("#")]),a._v(" 进行全量备份")]),a._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[a._v("docker "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("exec")]),a._v(" pgsql /bin/bash -c "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"mkdir -p /backup/'),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$(")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("date")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v("'+%Y-%m-%d'")]),t("span",{pre:!0,attrs:{class:"token variable"}},[a._v(")")])]),a._v(" && pg_basebackup -D /backup/"),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$(")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("date")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v("'+%Y-%m-%d'")]),t("span",{pre:!0,attrs:{class:"token variable"}},[a._v(")")])]),a._v(' -Upostgres"')]),a._v(" \n\n")])])]),t("ul",[t("li",[a._v("带压缩的命令")])]),a._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[a._v(" docker "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("exec")]),a._v(" pgsql /bin/bash -c "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"mkdir -p /backup/'),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$(")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("date")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v("'+%Y-%m-%d'")]),t("span",{pre:!0,attrs:{class:"token variable"}},[a._v(")")])]),a._v(" && pg_basebackup -D /backup/"),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$(")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("date")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v("'+%Y-%m-%d'")]),t("span",{pre:!0,attrs:{class:"token variable"}},[a._v(")")])]),a._v(' -Upostgres -Ft -z -v"')]),a._v("\n")])])]),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[a._v("drwxr-xr-x. "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("19")]),a._v(" root    root  "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("4096")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("10")]),a._v("月 "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("15")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("18")]),a._v(":11 "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("2020")]),a._v("-10-15\ndrwxr-xr-x.  "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("2")]),a._v(" polkitd input "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("4096")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("10")]),a._v("月 "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("15")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("18")]),a._v(":11 pg_archive\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("root@localhost backup"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("## du -sh 2020-10-15/")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v(".3G    "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("2020")]),a._v("-10-15/\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("root@localhost backup"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("##")]),a._v("\n")])])]),t("h2",{attrs:{id:"恢复"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#恢复"}},[a._v("#")]),a._v(" 恢复")]),a._v(" "),t("ul",[t("li",[a._v("解压缩相应日期下的备份，并复制到数据卷对应的数据库集簇目录，例如挂载方式为/home/data/docker/pgdata:/var/lib/postgres/data 则复制到宿主机的/home/data/docker/pgdata下")])]),a._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("root@localhost "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("2020")]),a._v("-10-16"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("## pwd")]),a._v("\n/home/backup/2020-10-16\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("tar")]),a._v(" -xzvf base.tar.gz\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("cp")]),a._v(" * /data/docker/pgsql/pgdata/\n")])])]),t("ul",[t("li",[a._v("配置好相应的docker-compose.yml （注意不能现在还不能启动）")]),a._v(" "),t("li",[a._v("$PGDATA 目录创建 recovery.conf 文件，配置恢复信息")])]),a._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("cat")]),a._v(" recovery.conf\n\nrestore_command "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v("'gunzip < /backup/pg_archive/%f.gz > %p'")]),a._v("                    \n\nrecovery_target_time "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v("'2020-10-14 16:38:00+08'")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("## recovery_target_timeline = 'latest'")]),a._v("\n\n")])])]),t("ul",[t("li",[a._v("docker-compose.yml 所在目录 执行 docker-compose up -d")]),a._v(" "),t("li",[a._v("连接上数据库之后，执行 "),t("code",[a._v("select pg_wal_replay_resume(); ## 必须使用该命令来截断wal 恢复中的部分信息(恢复的时间节点，使得wal文件并没有完全执行完)")])])]),a._v(" "),t("h3",{attrs:{id:"recovery-conf"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#recovery-conf"}},[a._v("#")]),a._v(" recovery.conf")]),a._v(" "),t("ul",[t("li",[a._v("recovery_target = ‘immediate’ :这个参数指定恢复应该在达到一个一致状态后尽快结束，即尽早结束。在从一个在线备份中恢复时，这意味着备份结束的那个点。")]),a._v(" "),t("li",[a._v("recovery_target_name (string) :指定（pg_create_restore_point()所创建）的已命名的恢复点，进行恢复。")]),a._v(" "),t("li",[a._v("recovery_target_time (timestamp) ：这个参数指定按时间戳恢复。")]),a._v(" "),t("li",[a._v("recovery_target_xid (string) ：这个参数指定按事务 ID进行恢复。")]),a._v(" "),t("li",[a._v("recovery_target_lsn (pg_lsn) ：这个参数指定按继续进行的预写日志位置的LSN进行恢复。")]),a._v(" "),t("li",[a._v("recovery_target_inclusive (boolean)：指定我们是否仅在指定的恢复目标之后停止（true）， 或者仅在恢复目标之前停止（false）。 适用于recovery_target_lsn、recovery_target_time - 或者recovery_target_xid被指定的情况。 这个设置分别控制事务是否有准确的目标WAL位置(LAN)、提交时间或事务ID将被包括在该恢复中。 默认值为true。")]),a._v(" "),t("li",[a._v("recovery_target_timeline (string) ：指定恢复到一个特定的时间线中。默认值是沿着基础备份建立时的当前时间线恢复。将这个参数设置为latest会恢复到该归档中能找到的最新的时间线。")]),a._v(" "),t("li",[a._v("recovery_target_action (enum) ：指定在达到恢复目标时服务器应该立刻采取的动作，包括pause（暂停）、promote（接受连接）、shutdown（停止服务器），其中pause为默认动作")])]),a._v(" "),t("h2",{attrs:{id:"定时任务执行备份-并删除过期文件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#定时任务执行备份-并删除过期文件"}},[a._v("#")]),a._v(" 定时任务执行备份，并删除过期文件")]),a._v(" "),t("ul",[t("li",[a._v("定时任务,每天凌晨 0点5分执行该脚本，并记录执行日志")])]),a._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("root@localhost backup"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("## crontab -l")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("5")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),a._v(" * * * /bin/bash /data/backup/cron/pg_backup_and_clear.sh "),t("span",{pre:!0,attrs:{class:"token operator"}},[t("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[a._v("1")]),a._v(">>")]),a._v("/data/backup/log/backup.log "),t("span",{pre:!0,attrs:{class:"token operator"}},[t("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[a._v("2")]),a._v(">")]),t("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[a._v("&1")]),a._v("\n")])])]),t("ul",[t("li",[a._v("具体脚本")])]),a._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("root@localhost backup"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("## cat cron/pg_backup_and_clear.sh ")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("##!/bin/bash")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("export")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("backupPath")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("/data/backup\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("export")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("fileKeep")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("+20\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("echo")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$(")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("date")]),a._v(" +"),t("span",{pre:!0,attrs:{class:"token string"}},[a._v("'%F %H:%M:%S'")]),t("span",{pre:!0,attrs:{class:"token variable"}},[a._v(")")])]),a._v(' backup start"')]),a._v("\ndocker "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("exec")]),a._v(" pgsql /bin/bash -c "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"mkdir -p /backup/'),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$(")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("date")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v("'   +%Y-%m-%d'")]),t("span",{pre:!0,attrs:{class:"token variable"}},[a._v(")")])]),a._v(" && pg_basebackup -D /backup/"),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$(")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("date")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v("'+%Y-%m-%d'")]),t("span",{pre:!0,attrs:{class:"token variable"}},[a._v(")")])]),a._v(' -Upostgres -Ft -z -v"')]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("echo")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$(")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("date")]),a._v(" +"),t("span",{pre:!0,attrs:{class:"token string"}},[a._v("'%F %H:%M:%S'")]),t("span",{pre:!0,attrs:{class:"token variable"}},[a._v(")")])]),a._v(' backup finish"')]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("find")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$backupPath")]),a._v(" -name "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"*.tar.gz"')]),a._v(" -mtime "),t("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$fileKeep")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("xargs")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("rm")]),a._v(" -fr\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("find")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$backupPath")]),a._v(" -name "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"*-*-*"')]),a._v(" -mtime "),t("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$fileKeep")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("xargs")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("rm")]),a._v(" -fr\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("find")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$backupPath")]),a._v("/pg_archive -mtime "),t("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$fileKeep")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("xargs")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("rm")]),a._v(" -fr\n")])])]),t("h2",{attrs:{id:"定时任务执行有效期加10年的操作"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#定时任务执行有效期加10年的操作"}},[a._v("#")]),a._v(" 定时任务执行有效期加10年的操作")]),a._v(" "),t("ul",[t("li",[a._v("注意这里转义字符的使用，还是挺讲究的")])]),a._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[a._v("docker "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("exec")]),a._v(" pgsql /bin/bash -c "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"psql -U postgres -d zegobirdWMS_Storage -c '),t("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[a._v('\\"')]),a._v("UPDATE tb_locationstock SET expirationdate = expirationdate + INTERVAL '10 YEAR' WHERE expirationdate < '2025-01-01'"),t("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[a._v('\\"')]),a._v('"')]),a._v("\n")])])]),t("h2",{attrs:{id:"切换wal-日志"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#切换wal-日志"}},[a._v("#")]),a._v(" 切换wal 日志")]),a._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("select")]),a._v(" pg_switch_wal"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n")])])])])}),[],!1,null,null,null);s.default=r.exports}}]);